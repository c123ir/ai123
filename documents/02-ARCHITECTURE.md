# 02-ARCHITECTURE.md - معماری پروژه دستیار هوشمند یک دو سه

## مقدمه

این سند، معماری کلی پروژه دستیار هوشمند یک دو سه (SmartAi123) را تشریح می‌کند. معماری طراحی شده بر اساس اصول مقیاس‌پذیری، توسعه‌پذیری و نگهداری آسان طراحی شده است.

## دیاگرام معماری کلی

```
+----------------------------------+
|          مرورگر کاربر            |
+----------------------------------+
               |
               v
+----------------------------------+
|       فرانت‌اند (React.js)        |
|  +-----------------------------+ |
|  |         کامپوننت‌ها         | |
|  +-----------------------------+ |
|  |       مدیریت حالت          | |
|  |    (Context API / Redux)    | |
|  +-----------------------------+ |
|  |     سرویس‌های API          | |
|  +-----------------------------+ |
+----------------------------------+
               |
               v
+----------------------------------+
|        بک‌اند (Express.js)        |
|  +-----------------------------+ |
|  |        روت‌ها              | |
|  +-----------------------------+ |
|  |       کنترلرها            | |
|  +-----------------------------+ |
|  |       سرویس‌ها             | |
|  +-----------------------------+ |
|  |          DAO               | |
|  +-----------------------------+ |
+----------------------------------+
               |
               v
+----------------------------------+
|       پایگاه داده و ذخیره‌سازی     |
|  +-------------+ +------------+ |
|  | PostgreSQL  | |   Redis    | |
|  +-------------+ +------------+ |
+----------------------------------+
```

## لایه‌های معماری

### 1. لایه ارائه (Presentation Layer)

#### فرانت‌اند (React.js)
- **کامپوننت‌ها**: واسط کاربری و عناصر بصری
- **مدیریت حالت**: مدیریت وضعیت برنامه با Redux یا React Context API
- **سرویس‌های API**: برقراری ارتباط با بک‌اند
- **مسیریابی**: مدیریت مسیرهای برنامه با React Router
- **قالب‌بندی**: استفاده از Styled Components/Material UI برای استایل‌دهی
- **فرم‌ها**: مدیریت و اعتبارسنجی فرم‌ها با Formik یا React Hook Form
- **بین‌المللی‌سازی**: پشتیبانی از زبان فارسی و RTL با React i18next

### 2. لایه کاربردی (Application Layer)

#### بک‌اند (Express.js)
- **روت‌ها (Routes)**: تعریف مسیرهای API
- **کنترلرها (Controllers)**: مدیریت درخواست‌ها و پاسخ‌ها
- **سرویس‌ها (Services)**: پیاده‌سازی منطق کسب‌وکار
- **میان‌افزارها (Middlewares)**: 
  - احراز هویت
  - مدیریت خطا
  - ثبت لاگ
  - فشرده‌سازی
  - تبدیل اعداد فارسی به انگلیسی

### 3. لایه دسترسی به داده (Data Access Layer)

#### DAO (Data Access Objects)
- **مدل‌ها**: تعریف ساختارهای داده
- **Repository**: واسط دسترسی به داده
- **ORM**: استفاده از Sequelize یا TypeORM برای تعامل با پایگاه داده

### 4. لایه ذخیره‌سازی (Persistence Layer)

#### پایگاه داده‌ها
- **PostgreSQL**: ذخیره‌سازی اصلی داده‌های سیستم
- **Redis**: 
  - ذخیره‌سازی کش
  - مدیریت جلسات
  - صف‌های کاری

## معماری میکروسرویس

پروژه از معماری میکروسرویس سبک (Lightweight Microservices) استفاده می‌کند که شامل سرویس‌های زیر است:

### 1. سرویس هسته (Core Service)
- مدیریت کاربران
- احراز هویت
- مدیریت دسترسی‌ها

### 2. سرویس توکن (MoneyBell Service)
- مدیریت توکن‌های مانیبل
- صدور و مصرف توکن
- محاسبه پاداش‌ها

### 3. سرویس اطلاع‌رسانی (Notification Service)
- مدیریت اعلان‌ها
- ارسال ایمیل
- ارسال پیامک

### 4. سرویس گزارش‌گیری (Reporting Service)
- تولید گزارش‌ها
- داشبوردهای تحلیلی
- آمار و ارقام

### 5. سرویس پرداخت (Payment Service)
- مدیریت تراکنش‌ها
- ارتباط با درگاه پرداخت
- صدور فاکتور

## جریان داده

### ثبت‌نام و احراز هویت

```
+-------------+     +---------------+     +----------------+     +---------------+
| درخواست کاربر| --> | اعتبارسنجی داده | --> | ذخیره در دیتابیس | --> | ایجاد توکن JWT |
+-------------+     +---------------+     +----------------+     +---------------+
                                                                        |
+---------------+     +---------------------+     +-----------------+   |
| پاسخ به کاربر | <-- | ارسال ایمیل تأییدیه | <-- | ثبت لاگ فعالیت | <--+
+---------------+     +---------------------+     +-----------------+
```

### تولید و مصرف توکن مانیبل

```
+----------------------+     +-------------------+     +-------------------+
| رویداد تولید کننده توکن | --> | محاسبه میزان توکن | --> | افزایش موجودی کاربر |
+----------------------+     +-------------------+     +-------------------+
                                                              |
+-----------------+     +----------------------+     +--------v---------+
| اطلاع به کاربر  | <-- | ثبت تراکنش در دیتابیس | <-- | به‌روزرسانی پروفایل |
+-----------------+     +----------------------+     +------------------+
```

## مدل داده

### رابطه‌های اصلی

```
+------------+       +------------+       +------------+
|   کاربران   |<----->|  توکن‌ها    |<----->|  تراکنش‌ها  |
+------------+       +------------+       +------------+
      |                   |                   |
      v                   v                   v
+------------+       +------------+       +------------+
|  پروفایل‌ها  |       |  پاداش‌ها   |       |  پرداخت‌ها  |
+------------+       +------------+       +------------+
      |                                        |
      v                                        v
+------------+                           +------------+
|  اعلان‌ها    |                           |  فاکتورها   |
+------------+                           +------------+
```

## امنیت

### لایه‌های امنیتی

1. **احراز هویت**: استفاده از JWT برای احراز هویت
2. **مجوزدهی**: کنترل دسترسی بر اساس نقش (RBAC)
3. **رمزنگاری**: رمزنگاری داده‌های حساس 
4. **محافظت API**: استفاده از rate limiting و CORS
5. **امنیت انتقال**: استفاده از HTTPS و TLS 1.3
6. **حفاظت از حملات رایج**: 
   - XSS
   - CSRF
   - SQL Injection
   - DDoS

## زیرساخت و استقرار

### محیط‌های مختلف

1. **توسعه (Development)**:
   - اجرای محلی روی کامپیوتر توسعه‌دهندگان
   - استفاده از Docker برای یکسان‌سازی محیط

2. **تست (Testing)**:
   - سرور مجازی برای تست یکپارچگی
   - اجرای خودکار تست‌ها پس از هر Push

3. **پیش‌تولید (Staging)**:
   - محیط مشابه تولید برای تست نهایی
   - استفاده از داده‌های مشابه تولید

4. **تولید (Production)**:
   - استقرار در ابر (Cloud)
   - مقیاس‌پذیری خودکار
   - پایش مداوم

### فرآیند CI/CD

```
+----------+     +------------+     +----------+     +------------+
|   Push   | --> |  ساخت کد   | --> |   تست   | --> | استقرار خودکار |
+----------+     +------------+     +----------+     +------------+
```

## تکنولوژی‌های اصلی

### فرانت‌اند
- **فریم‌ورک اصلی**: React.js با TypeScript
- **مدیریت حالت**: Redux Toolkit و React Context API
- **مسیریابی**: React Router v6
- **اعتبارسنجی فرم**: Formik + Yup
- **استایل‌دهی**: Ant Design / Styled Components
- **کامپوننت‌های تاریخ**: تقویم شمسی (jalali-react-datepicker)
- **نمودارها**: Ant Design Charts
- **چندزبانی**: i18next با پشتیبانی RTL

### بک‌اند
- **فریم‌ورک اصلی**: Express.js با TypeScript
- **ORM**: Sequelize / TypeORM
- **احراز هویت**: JWT و Passport.js
- **اعتبارسنجی**: Joi / Zod
- **مستندسازی API**: Swagger
- **لاگینگ**: Winston
- **تست**: Jest و Supertest

### پایگاه داده و ذخیره‌سازی
- **پایگاه داده اصلی**: PostgreSQL
- **کش**: Redis
- **مدیریت فایل**: مخزن محلی / AWS S3

### زیرساخت
- **کانتینرسازی**: Docker
- **ارکستراسیون**: Docker Compose / Kubernetes
- **CI/CD**: GitHub Actions
- **پایش**: Prometheus و Grafana

## مسیر توسعه آینده

### فاز‌های برنامه‌ریزی شده

1. **فاز اول**: پیاده‌سازی هسته اصلی سیستم
   - پنل کاربری پایه
   - سیستم توکن مانیبل (MoneyBell)
   - مدیریت کاربران

2. **فاز دوم**: توسعه امکانات کاربردی
   - داشبوردهای تحلیلی
   - گزارش‌های پیشرفته
   - قابلیت‌های اجتماعی

3. **فاز سوم**: بهینه‌سازی و مقیاس‌پذیری
   - بهبود عملکرد
   - مقیاس‌پذیری افقی
   - هوش مصنوعی و یادگیری ماشین

## نتیجه‌گیری

معماری تشریح شده، چارچوبی مقیاس‌پذیر، انعطاف‌پذیر و قابل نگهداری برای پروژه دستیار هوشمند یک دو سه فراهم می‌کند. این معماری با تأکید بر جداسازی دغدغه‌ها، اصول طراحی شیءگرا و الگوهای طراحی مدرن، بستری مناسب برای توسعه اصولی و پایدار پروژه ایجاد می‌کند.