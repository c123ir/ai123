خیلی خوب، با توجه به مراحلی که انجام دادیم، مستندات تکمیلی زیر را برای تنظیم و راه‌اندازی پایگاه داده در سیستم‌های مک جدید آماده کرده‌ام:

# راهنمای راه‌اندازی پایگاه داده پروژه دستیار هوشمند ۱۲۳ در سیستم‌های مک

این راهنما برای راه‌اندازی پایگاه داده پروژه دستیار هوشمند ۱۲۳ در سیستم‌های مک جدید تهیه شده است. روش ارائه شده بر پایه داکر بوده و نیازی به نصب جداگانه PostgreSQL و Redis ندارد.

## پیش‌نیازها

- نصب [Docker Desktop برای Mac](https://www.docker.com/products/docker-desktop/)
- سیستم‌عامل macOS 12 یا بالاتر
- حداقل 4GB فضای خالی دیسک
- اطمینان از اجرای سرویس Docker

## مراحل راه‌اندازی

### 1. راه‌اندازی کانتینرهای داکر

1. به دایرکتوری سرور بروید:
   ```bash
   cd server
   ```

2. با استفاده از Docker Compose، سرویس‌های پایگاه داده را راه‌اندازی کنید:
   ```bash
   docker-compose up -d
   ```

   این دستور دو کانتینر راه‌اندازی می‌کند:
   - **PostgreSQL**: روی پورت 5433 (به جای پورت استاندارد 5432)
   - **Redis**: روی پورت 6380 (به جای پورت استاندارد 6379)

3. برای بررسی وضعیت کانتینرها، می‌توانید از دستور زیر استفاده کنید:
   ```bash
   docker ps
   ```

### 2. اجرای مهاجرت‌های پایگاه داده

برای ایجاد ساختار جداول در پایگاه داده، باید مهاجرت‌ها را اجرا کنید:

```bash
npx ts-node src/migrations/run-migrations.ts
```

پس از اجرای موفقیت‌آمیز، باید پیام زیر را مشاهده کنید:
```
✅ مهاجرت‌های پایگاه داده با موفقیت کامل شد
```

### 3. بررسی صحت راه‌اندازی

برای اطمینان از صحت راه‌اندازی پایگاه داده، می‌توانید:

1. وضعیت جداول ایجاد شده را بررسی کنید:
   ```bash
   docker exec -it computer123_postgres psql -U postgres -d computer123 -c "\dt"
   ```

   باید جداول `users`، `notifications` و `migrations` را مشاهده کنید.

2. اجرای سرور برای تأیید اتصال:
   ```bash
   npm run dev
   ```

   پس از راه‌اندازی موفق، پیام زیر نمایش داده می‌شود:
   ```
   info: ✅ اتصال به پایگاه داده با موفقیت برقرار شد
   🚀 سرور روی پورت 5454 در حال اجراست
   ```

## مدیریت پایگاه داده

### دستورات مفید داکر

- **توقف کانتینرها**:
  ```bash
  docker-compose down
  ```

- **راه‌اندازی مجدد کانتینرها**:
  ```bash
  docker-compose up -d
  ```

- **مشاهده لاگ‌های کانتینرها**:
  ```bash
  docker logs computer123_postgres
  docker logs computer123_redis
  ```

- **اتصال مستقیم به پایگاه داده**:
  ```bash
  docker exec -it computer123_postgres psql -U postgres -d computer123
  ```

### تنظیمات پایگاه داده

پیکربندی پایگاه داده در فایل‌های زیر قرار دارد:

1. **docker-compose.yml**: تنظیمات کانتینرهای Docker
   - پورت PostgreSQL: 5433
   - پورت Redis: 6380
   - نام کاربری PostgreSQL: postgres
   - رمز عبور PostgreSQL: postgres
   - نام پایگاه داده: computer123

2. **.env**: تنظیمات متغیرهای محیطی برای اتصال به پایگاه داده
   ```
   DB_HOST=localhost
   DB_PORT=5433
   DB_NAME=computer123
   DB_USER=postgres
   DB_PASSWORD=postgres

   REDIS_HOST=localhost
   REDIS_PORT=6380
   REDIS_PASSWORD=
   ```

3. **src/config/database.ts**: کد پیکربندی اتصال به پایگاه داده

## حل مشکلات رایج

### مشکل 1: خطای اتصال به پایگاه داده

**علائم:**
- پیام خطای "Failed to connect to database"
- سرور با خطا مواجه می‌شود

**راه حل:**
1. بررسی وضعیت کانتینرها:
   ```bash
   docker ps
   ```
2. در صورت عدم اجرای کانتینرها، مجدداً راه‌اندازی کنید:
   ```bash
   docker-compose up -d
   ```
3. بررسی تطابق تنظیمات `.env` با `docker-compose.yml`

### مشکل 2: خطا در اجرای مهاجرت‌ها

**علائم:**
- پیام خطای "Error in running migration"

**راه حل:**
1. بررسی اتصال به پایگاه داده
2. بررسی دسترسی‌های کاربر پایگاه داده
3. در صورت نیاز به شروع مجدد، می‌توانید پایگاه داده را بازنشانی کنید:
   ```bash
   docker-compose down -v
   docker-compose up -d
   ```
   سپس مجدداً مهاجرت‌ها را اجرا کنید.

### مشکل 3: تداخل پورت‌ها

**علائم:**
- پیام خطای "Port is already in use"

**راه حل:**
1. بررسی پورت‌های در حال استفاده:
   ```bash
   lsof -i :5433
   lsof -i :6380
   ```
2. تغییر پورت‌ها در فایل `docker-compose.yml` و `.env`

## پشتیبانی از داده‌ها

برای اطمینان از حفظ داده‌ها، می‌توانید:

1. **تهیه نسخه پشتیبان**:
   ```bash
   docker exec -t computer123_postgres pg_dump -U postgres -d computer123 > backup.sql
   ```

2. **بازیابی نسخه پشتیبان**:
   ```bash
   cat backup.sql | docker exec -i computer123_postgres psql -U postgres -d computer123
   ```

---

با پیروی از این راهنما، پایگاه داده پروژه دستیار هوشمند ۱۲۳ با موفقیت در سیستم مک شما راه‌اندازی خواهد شد. در صورت مواجهه با مشکل، به بخش "حل مشکلات رایج" مراجعه کنید یا با تیم پشتیبانی تماس بگیرید.
